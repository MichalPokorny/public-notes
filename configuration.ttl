:megalocap rdfs:label "Lenovo X230" .
:feynmann rdfs:label"Nejstarsi notebook (Asrock)" .
:vakarian rdfs:label "HP 4530s" .
:dragon rdfs:label "Server" .

:megalocap :note "Test-server kazdou hodinu" ;
	:note "Androidovy path (/opt/android-sdk/platform-tools)" ;
	:note "enable cups demon" .

:generic-mapping :note """
Generic mapping!!! (musim testovat, ze funguje dobre)
	GENERIC na serveru i na notebooku!
""" ;
	:under :dragon ;
	:under :megalocap .

:megalocap :note "/etc/acpid: obsahuje eventy na lenovo dock a undock kvuli koleji".

:configuration :note """
	available: prvak.name (6.4 eur na rok),
	prvak.info (7.4 eur na rok)
MOZNA SI BUDU MOCT UKRADNOUT prvak.cz!
	- pokorny.name
	- prvak.name
	- prvak.info
""" .

:configuration :todo "POSTFIX BOUNCES POSILEJ NA POK@RNY.CZ!" ;
	:todo "cannot access ~/notes if it's not mounted" ;
	:todo "must not start Dropbox if it's not mounted" ;
	:todo "create cold backup, not bound to dropbox?" ;
	:todo "test that dropbox keeps extended attributes" ;
	:todo "unbreak kbcsvgrab.py" ;
	:todo "jaky je Dropbox SLA?" .

:megalocap :note """
	Checklist:
	- konfigurak k postfixu
	- nainstalovat xosdutil, xosdutilctl.

	Demoni: postfix

	- /etc/hosts aby obsahovalo hostname
""" ;
	:todo "check spravnosti (ze dokazu vsechno spustit)" .

:megalocap :note """
	MAC: 3C:97:0E:C1:07:59
	/root ma jine dotfily - specialne napriklad nema xosdutil reference a vim bundly
		TODO: udelat z toho jinou variantu v gitu?
	Log:
		- installed powertop, xf86-video-intel, autoconf, automake
		- enabled atd, cronie
		- zkopirovano .mozilla
		- syslog-ng
		- sudoers
		- lid no suspend
		- x11: nolisten tcp
		- updatedb.conf pruning
		- enable smartd (+warning)
		- mergnut postfix, aktivovan smartd
		- add prvak to wireshark
		- install fakeroot (abych mohl buildovat yaourt baliky pod rootem)
		- enable multilib for wine
		- xvidcap (+rarian)
	""" ;
	:note "Dokovaci stanice: potreba klicem pohnout kousek na druhou stranu pred za/odmykanim" ;
	:note """
	LED diody:
		/proc/acpi/ibm/led

		echo "0 off/on/blink"
		0: dioda na zapinacim tlacitku
		7: mesicek na zadni strane
		12: ???
	""" ;
	:note "ebay: 40 usd za 9clankovou baterii, 80 usd za pridavnou 6-clankovou" ;
	:note "vypnuti touchpadu: synclient TouchpadOff=1 (nebo 0)" .

:dragon :note """
	systemctl enable sshd
	reboot
	-----
	pacman -S postfix
	(chybi libsasl2)
	pacman -S libsasl
	reboot
	(ssh funguje)
	(nakopceni souboru)
	useradd prvak
	mkdir ~prvak
	chmod -R 755 ~prvak; chown prvak:prvak ~prvak -R
	pacman -S mc vim htop mlocate
	postfix: update myhostname, mydomain, myorigin, inet_interfaces, mydestination, home_mailbox,
		(sendmail path), velky chunk na konci, master.cf port;
	virtual; postmap virtual: porad tomu vadi libsasl2.so.2!!!
	updatedb
	pacman -Sy
	pacman -Su postfix --ignore bash,filesystem
	(reinstall postfix)
	============================================
	systemctl enable postfix
	pacman -S dovecot
	systemctl enable dovecot
	(aliases)
	postalias aliases
	postmap virtual
	systemctl start postfix dovecot (fail): open directory defer: permission denied
	(otoceni instalace postfixu)
	(presunuti pacsave zpatky - virtual, aliases)
	systemctl start postfix: OK
	systemctl enable syslog-ng
	(chybi SSL certifikat - kopiruji vcetne klicu pro dovecot a postfix)
	(copy dovecot config)
	systemctl restart postfix dovecot
	reboot
	ssh OK.
	(kopiruju vimrc, odstranuju pathogen referenci, syntastic referenci)
	(chybi dovecot certifikat a je chyba v configu)
	(OK, dovecot startuje)
	(auth failed - /etc/pam.d/dovecot missing)
	(restart dovecot)
	(heslo pro prvaka)
	OK :)
	TODO: naucit zalohovat pravidelne vlastni etccka
	(nakopiruju bashrc, bash_profile)
	OK
	nakopirovavam puvodni obsah http
	ssh-copy-id prvak@rny.cz
	TODO: zakazat cteni secrets ostatnim na serveru!
	kopirovani obsahu homu - .ssh hlavne, secrets; konfiguraky
	pacman -S ack
	rny.cz: it works.
	cp .gnupg, Maildir (56M)
	pacman -S htop git
	allow key
	pacman -S strace
	==============
	VVV ??????
		MegaCli
		lsiutil
		mpt-status
		tw_cli
	=====
	pokus o apache
	pacman -S apache
	systemctl enable httpd
	pacman -S fail2ban
	zalozeni uzivatele pp, symlink do ordinace, pridani prav zapisu
	motd, hostname "dragon"
	LAMP:
		pacman -S php php-apache

		ServerSignature Off
		ServerTokens Prod

		LoadModule php5_module modules/libphp5.so

		Include conf/extra/php5_module.conf
		uncomment MIMEMagicFile conf/magic

		pridat do mime.types: application/x-httpd-php php php5

		(test.php - phpinfo: funguje to)

	php.ini:
		date.timezone = Europe/Prague
		extension=ftp.so
		extension=gd.so
		extension=iconv.so
		extension=openssl.so
		extension=zip.so

	Virtualni host work.

	pacman -S vsftpd
	systemctl enable vsftpd
	systemctl start vsftpd

	/etc/vsftpd: anonymous_enable=NO
		local_enable=YES
		write_enable=YES
		local_umask=022

	/etc/ssh/sshd_config: zmena LogLevel INFO na LogLevel VERBOSE aby fungoval fail2ban

	fail2ban: vsftpd-iptables - zapnout, konf. mailu
		ssh-iptables - zapnout, konf. mailu

	iptables aby fungovalo fail2ban:
		(pacman -S iptables)

		systemctl enable iptables
		systemctl start iptables

		cp /etc/iptables/empty.rules /etc/iptables/iptables.rules (aby to slo zapnout)
		systemctl start iptables

	systemctl restart fail2ban

	vhost pp
	symlink v ~pp na pp.rny.cz

	(presun srv do /home/srv)
	(ln -s /home/srv /srv)

	(prepnuti fail2ban tak, aby se to koukalo spravne do /var/log/auth.log)

	Je potreba mit hodinovy cron na wget http://rezervace.cardiofitnessdc.cz/?presenter=Cron -O/dev/null -o/dev/null > /dev/null.
		(Je to nejaky historicky duvod. Neslo to nastavit na cardiofitnessdc serveru...)

	pacman -S uptimed
	systemctl enable uptimed; systemctl start uptimed

	postfix virtual: "pok@rny.cz prvak@localhost" aby slo posilat maily primo z dragonu (??)

	barvicky v /etc/bash.bashrc

	pacman -S colordiff mlocate
	systemctl enable fail2ban, start fail2ban

	-- fail2ban si stezuje v logu na spatnou syntaxi iptables --
	-- zmenen defaultni jail aby to fungovalo --

	apache: vhost rny.cz dany jako default

	systemctl enable ntpd

	orldecin.cz:
		ServerName orldecin.cz
		ServerAlias www.orldecin.cz orldecin.cz

	systemctl enable cronie
	systemctl start cronie

	cron.hourly: rezervace_tick

	obnovuju obsah /root.
		.bash_profile
		.bashrc

	KROK 1) Kopiruju stary server k sobe na disk.

	Seznam sluzeb na serveru:
		* FTP na ordinaci?

		~pp/pp.rny.cz

	Priority:
		1) mail (SMTP & POP3 & IMAP)
		2) ordinace
		3) osobni web

	PLAN OPERACE:
		1) dam instalovat novy Arch
		2) passwd, ssh-copy-id
		3) pacman -Syu
		--- restart ---

		Jestli to tady nabootuje, budu pokracovat.
		4)
			pacman -S elinks hddtemp htop iputils postfix rsync screen strace syslog-ng systemd-sysvcompat uptimed v8 vim

			useradd prvak
			passwd prvak
			ssh-copy-id

		5)	zahajit restoraci z FTP -- nakopirovat nekam do vhodneho mista a soubor po souboru narovnavat
		6) Postfix, Dovecot, peclive otestovat ze to funguje vcetne SSL

		1) 00:03: spustena reinstalace serveru
		2) 00:21: dorazil mail s heslem
			passwd, ssh-copy-id

		3) 00:26: mam heslo a klic
			pacman -Syu ==> nothing to do

		4) 00:27: reboot

		5) 00:28: install
	,
			pacman -S bc bind cronie dovecot elinks fail2ban git grub hddtemp htop iputils mc mutt cfdisk php-apache postfix rsync ruby screen smartmontools strace syslog-ng systemd-sysvcompat uptimed v8 vim vsftpd apache

			(cfdisk not found -- uz tam je)

			hostname (/etc/hostname): ks389438 ==> wintermute

		6) zahajeni restorace z FTP -- kopiruju

			Mezitim na pozadi (protoze se tech dat kopiruje hodne) zacinam s restoraci postfixu a dovecotu.

			systemctl enable syslog-ng
			systemctl start syslog-ng

		7*) (mezitim co kopiruju)
			useradd -m prvak
			passwd prvak

			ssh-copy-id prvak@rny.cz

		8*) (mezitim co kopiruju, mam uz etc)

			(nakopirovani a nadiffovani konfiguraku)

			diff /home/_FTP_RESTORE/postfix/ /etc/postfix/ > ~/postfix-diff

			aliases: 'root: you' ==> 'root: prvak'
				'pok: prvak' (pok@rny.cz)
			$ postalias aliases
			$ postmap generic

			main.cf:
				myhostname = mail.rny.cz
				mydomain = rny.cz
				myorigin = $mydomain
				inet_interfaces = all
				mydestination = $myhostname, localhost.$mydomain, localhost,
					$mydomain, mail.$mydomain, www.$mydomain, ftp.$mydomain
				home_mailbox = Maildir/

				# A na konec:
				smtpd_sasl_auth_enable = yes
				smtpd_sasl_type = dovecot
				smtpd_sasl_path = private/auth
				broken_sasl_auth_clients = yes
				smtpd_sasl_security_options = noanonymous
				smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated reject_unauth_destination
				smtpd_recipient_restrictions = permit_mynetworks permit_sasl_authenticated reject_unauth_destination

				smtpd_tls_cert_file = /etc/ssl/certs/postfix.crt
				smtpd_tls_key_file = /etc/ssl/private/postfix.pem
				smtpd_tls_security_level = may

				# Warningy, kdyz je mail delsi dobu ve queue.
				delay_warning_time = 15m

				smtp_generic_maps = hash:/etc/postfix/generic

			master.cf:
				pridana radka se SMTP nestandartnim portem
				smtp      inet  n       -       n       -       -       smtpd

			virtual:
				pok@rny.cz prvak@localhost

			postmap virtual

			rm ~/postfix-diff

			systemctl enable postfix

			mkdir -p /etc/ssl/{certs,private} &&
			cp /home/_FTP_RESTORE/etc/ssl/certs/postfix.crt /etc/ssl/certs &&
			cp /home/_FTP_RESTORE/etc/ssl/private/postfix.pem /etc/ssl/private

			diff /home/_FTP_RESTORE/etc/dovecot/ /etc/dovecot/ > ~/dovecot-diff
			cp /home/_FTP_RESTORE/etc/dovecot/dovecot.conf /etc/dovecot

			systemctl start postfix dovecot

			(Test IMAPu)
			v mail.log:: Fatal: Couldn't parse private ssl_key: error:0906D06C:PEM routines:PEM_read_bio:no start line: Expecting: ANY PRIVATE KEY

			cp /home/_FTP_RESTORE/etc/dovecot/conf.d/10-ssl.conf /etc/dovecot/conf.d
			cp /home/_FTP_RESTORE/etc/dovecot/conf.d/10-auth.conf /etc/dovecot/conf.d

			cp /home/_FTP_RESTORE/etc/ssl/certs/dovecot.pem /etc/ssl/certs &&
			cp /home/_FTP_RESTORE/etc/ssl/private/dovecot.pem /etc/ssl/private

			systemctl restart postfix dovecot

			(Test: fetchmail se uspesne pripojil)
			(Test: mail na pok@rny.cz: OK, delivered & fetched)
			(Test: mail na root@rny.cz: OK, delivered & fetched)
			(Test: mail na mp@decin.cz: OK, delivered & fetched)

		9) Poustim dalsi kopirovani stareho /home.

		(01:17) je to nejak jakz takz funkcni.

		DALE BUDE POTREBA:
			- tatuv uzivatel a symlink do ordinace
	===
	zkopirovani srv/http a zmervoani konfigurace

	odebrat: - MIMEMagicFile
	MPM: prefork, ne event
	===> mam uz funkcni ordinaci
""" ;
	:todo "Shorten the above description." .

:megalocap :note """
Asi nejde vubec rekalibrovat baterka (v BIOSu to neni)

TEST SYSTEMU:
	- SMTP rny.cz, rny.cz:5257
	- HTTP rny.cz, work.rny.cz, poko.rny.cz, orldecin.cz, crm.b4f.cz

Server: zaply syslog-ng v systemd, abych mel logy z postfixu a tak

test-server kazdou hodinu
kazdych 6 hodin net-worth-keeper
kazdych 5 minut se zkontroluje, jestli uz 5 minut nebezi locknuty screensaver, a provede se pokus o unmount

ntpd

win-alt-h: spust htop

/usr/lib/systemd/system-sleep: skript co se pusti pri suspendu -- pokusi se odmontovat crypto a zamkne obrazovku
/etc/systemd/system/powertop-optimize.service: powertop --auto-tune
""" .

:raspberry :note """
	Nainstalovany software:
		dillo (chromium je uplne nepouzitelne, rekonq je taky pomaly)
			alternativy: dwb, epiphany, arora (firefox neni v repech)

	/etc/X11/xdm/Xservers: -nolisten tcp

	NTP: chce /var/tmp;
""" .

:vakarian :note """
	Heslo ulozeno v crypto/hesla.

	Je na nem speech synthesis:
		festival + english, us
		espeak
			Test Espeak with: English female voice, emphasis on capitals (-k), speaking slowly (-s) using direct text:-

			espeak -ven+f3 -k5 -s150 "I've just picked up a fault in the AE35 unit"

		echo "Hello World" | festival --tts

		espeak je mnohem modernejsi!
			TODO: umi i cestinu...
""" .

("mail system") :note """
	**Na serveru**
		dovecot
		postfix

			- bezi na alternativnim SMTP portu (5257)
				- BACHA NA TO, ABYCH NECHAL BEZET I TEN DEFAULTNI! (25)

			smtpd_tls_security_level = encrypt
			+ nastaveni certifikatu a klice

			delay_warning_time = 30m (!)

			Dovecot poskytuje Postfixu auth backend.

		POZOR! Dovecot version mismatch zpusobeny nerestartem po upgradu
		potichu zabije prichod mailu! EXPLICITNE KONTROLOVAT!

	**Na lokalu**
		postfix
			lokalni dorucovani:
				home_mailbox = .maildir/
			smtp_sasl_auth_enable=yes
			smtp_sasl_password_maps=hash:/etc/postix/saslpasswd
			smtp_always_send_ehlo=yes # PROC?
			smtp_sasl_security_options= # TODO: tohle je nebezpecne!
			smtp_generic_maps=hash:/etc/postfix/generic
			smtp_tls_security_level = encrypt

			generic:
				@tezitko.localdomain pok@rny.cz
				@localhost.localdomain pok@rny.cz

		symlink do crypta - saslpass, saslpass.db!

	BACHA: MUSIM MIT TAKY DOSTATECNE VYSOKY LIMIT NA VELIKOST ZPRAV

	smtpd_client_restrictions = permit_mynetworks,
		permit_sasl_authenticated,
		reject_unauth_destination,
		reject_rbl_client zen.spamhaus.org,
		reject_rbl_client bl.spamcop.net,
		reject_rbl_client cbl.abuseat.org,
		permit
""" .

:configuration :todo "naucit test-server zkusit to pozdeji znovu?" ;
	:todo "vim write & buffer delete" ;
	:todo "co se stane, kdyz odeberu notebook z doku zatimco spi? chci aby pochopil ze uz neni v doku..." ;
	:todo "timidity mi zere baterku... je potreba?" ;
	:todo "crypto header backup - cryptsetup luksHeaderBackup --header-backup-file <file> <device>" ;
	:todo "crypto backup" ;
	:todo "tweaky, co dela powertop, by se mely delat automaticky." ;
	:todo "suspend on lid switch unless mounted" ;
	:todo "proc xosdutil tak rychle skonci pri acpi?" ;
	:todo "opravit funkce suspendovacich tlacitek" ;

	:todo """
		screensaver-unmount si neumi detekovat displej, ktery je otevreny
			- muzu si zjistit PID xscreensaveru a pak se podivat do /proc/#{pid_xscreensaveru}/environ :D
			- moznost B: jednou za cas udelat rekoncilaci rucne
	""" ;
	:todo "zalohovat nekam moje konfiguraky Dragonu (a vubec cely Dragon)" ;
	:todo "crypto backup. a vubec lepsi zalohovani. (hesla a tak)" ;
	:todo "backup - .nobackup pro adresare, ktere fakt nechci zalohovat" ;
	:todo "pridat k `ovec` moznost konfigurace vlnkovanych vyrazu" ;
	:todo "skript co dela powertop optimalizace mi zabijel sitovku... :(" ;
	:todo "zalohovani fotek!" ;
	:todo "acpi hook xosdutil" ;
	:todo "vim skeletons" ;
	:todo "suspend: 'in 30 minutes'" ;
	:todo "ovec: seznam prikazu, ve kterych nevlnkovat, by mel byt nastavitelny (\"najdi si .ovecrc v parentech\")" ;
	:todo "goodnight by mel vypinat zvuk" ;
	:todo "nejak upozornovat ze nemam namontovane crypto" ;
	:todo "zsh: battery level" ;
	:todo "automaticky mail-pingovaci skript" ;
	:todo "xmonad-contrib: chci tam mit ten svuj patch, nebo pouzivat svuj layout" ;
	:todo "vypnout xoff/xon" ;
	:todo "jak naucit zsh aby disownoval joby?" ;
	:todo "vim -- vypnout v ...?-line upozorneni na mixed-indent" ;
	:todo "nedovolit move-to-crypto kdyz neni crypto mounted" ;
	:todo "napad: aplikace na to, ze jsem si zamkl" ;
	:todo "cryptounmount -- nerestartuje" .

:configuration :note """
	Postfix: Bacha: kdyz se separatne updatne postfix a dovecot, oba na to umrou, ale nebudou si stezovat zadnemu cloveku.
""" .

:notes rdfs:label "Note-taking system" ;
	:todo "consider using Notation 3 instead of Turtle?" .

:configuration :todo "set Firefox as default URL opener" ;
	:todo "rescuetime: stop collecting window + document titles?" .

:configuration :todo "Anki fails unless run from console because of nonstandard path" ;
	:todo "document server process, possibly create installation procedure" ;
	:todo "consider switching to password manager" ;
	:todo "enhance screenshot gathering. could I record everything?" ;
	:todo "physically back up Dropbox 2FA one-time access codes" .
	:todo "rewrite deduplicator in go" .
