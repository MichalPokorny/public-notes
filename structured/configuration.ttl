:megalocap :note "Lenovo X230" .
:feynmann :note "Nejstarsi notebook (Asrock)" .
:vakarian :note "HP 4530s" .
:dragon :note "Server" .

:megalocap :note "Test-server kazdou hodinu" ;
	:note "Androidovy path (/opt/android-sdk/platform-tools)" ;
	:note "enable cups demon" ;

:generic-mapping :note """
Generic mapping!!! (musim testovat, ze funguje dobre)
	GENERIC na serveru i na notebooku!
""" ;
	:under :dragon ;
	:under :megalocap .

:megalocap :note "/etc/acpid: obsahuje eventy na lenovo dock a undock kvuli koleji".

:configuration :note "available: prvak.name (6.4 eur na rok), prvak.info (7.4 eur na rok)" .

:megalocap :note """
	Checklist:
	- konfigurak k postfixu
	- nainstalovat xosdutil, xosdutilctl.

	Demoni: postfix

	- /etc/hosts aby obsahovalo hostname
	TODO: check spravnosti (ze dokazu vsechno spustit)
""" .

:dragon :note """
	pacman -Syu	# neproslo hned
	pacman -Syu --ignore bash,filesystem
	pacman -S bash
	pacman -Su (filesystem; presunul jsem soubory v /sbin)

	NEPROSLO: pak to nebootuje.

	pacman -Syu --ignore bash,filesystem
	systemctl enable sshd
	reboot

	-----

	pacman -S postfix
	(chybi libsasl2)
	pacman -S libsasl

	reboot

	(ssh funguje)
	(nakopceni souboru)

	useradd prvak
	mkdir ~prvak
	chmod -R 755 ~prvak; chown prvak:prvak ~prvak -R

	pacman -S mc vim htop mlocate

	postfix: update myhostname, mydomain, myorigin, inet_interfaces, mydestination, home_mailbox, 
		(sendmail path), velky chunk na konci, master.cf port;

	virtual; postmap virtual: porad tomu vadi libsasl2.so.2!!!

	updatedb

	pacman -Sy
	pacman -Su postfix --ignore bash,filesystem

	(reinstall postfix)

	(nejde to :( )
	pacman -Syu --ignore bash,filesystem

	mv sbin old-sbin
	pacman -S bash
	pacman -Su filesystem

	IT WORKS :)

	============================================

	systemctl enable postfix
	pacman -S dovecot

	systemctl enable dovecot

	postmap virtual

	(aliases)

	postalias aliases

	postmap virtual

	systemctl start postfix dovecot (fail): open directory defer: permission denied
	(otoceni instalace postfixu)

	(presunuti pacsave zpatky - virtual, aliases)

	systemctl start postfix: OK

	systemctl enable syslog-ng

	(chybi SSL certifikat - kopiruji vcetne klicu pro dovecot a postfix)

	(copy dovecot config)

	systemctl restart postfix dovecot

	reboot

	ssh OK.

	(kopiruju vimrc, odstranuju pathogen referenci, syntastic referenci)

	(chybi dovecot certifikat a je chyba v configu)

	(OK, dovecot startuje)

	(auth failed - /etc/pam.d/dovecot missing)

	(restart dovecot)

	(heslo pro prvaka)

	OK :)

	TODO: naucit zalohovat pravidelne vlastni etccka

	(nakopiruju bashrc, bash_profile)

	(instaluju ruby)

	OK

	nakopirovavam puvodni obsah http


	ssh-copy-id prvak@rny.cz

	TODO: zakazat cteni secrets ostatnim na serveru!

	kopirovani obsahu homu - .ssh hlavne, bin (btckit); secrets; konfiguraky

	presunuti ~/git

	pacman -S ack

	useradd b4f-crm; mkdir ~b4f-crm; chmod 755 -R ~b4f-crm; chown -R b4f-crm:b4f-crm ~b4f-crm

	kopirovani .ssh v b4f-crm; kopirovani gitu CRMka

	rny.cz: it works.

	cp .btckit, .gnupg, Maildir (56M)

	git: tata tam stejne nema pristup.

	pacman -S subversion

	cp conf.d/svnserve (nic - je to stejne...)

	systemctl enable svnserve; systemctl start svnserve

	gem install passenger

	pacman -S htop git mariadb

	useradd rails, mkdir /srv/rails/...

	allow key

	mysql_secure_installation

	TODO: mysql zalohovani

	systemctl start mysqld; systemctl enable mysqld

	pacman -S strace

	==============

	VVV ??????

	MegaCli
	lsiutil
	mpt-status
	tw_cli

	=====

	pokus o apache

	pacman -S apache
	passenge-install-apache2-module

	systemctl enable httpd

	pacman -S v8 nodejs sudo

	Vytvoril jsem v ~/backup/skripty/backup-mysql na tohle Ruby skript.
	Pridam uzivatele pro mysql:

		GRANT LOCK TABLES, SELECT ON *.* TO backup@localhost IDENTIFIED BY ...;

	pacman -S python2-pyinotify fail2ban
	aktivace (provedu to i na rincewindu); startovani

	zalozeni uzivatele pp, symlink do ordinace, pridani prav zapisu

	groupadd ordinace
	gpasswd -a rails ordinace
	gpasswd -a pp ordinace

	chgrp -R ordinace /srv/rails/ordinace
	chmod -R g+rwx /srv/rails/ordinace

	create group ordinace

	motd, hostname "dragon"

	LAMP: 
		pacman -S php php-apache

		ServerSignature Off
		ServerTokens Prod

		LoadModule php5_module modules/libphp5.so

		Include conf/extra/php5_module.conf
		uncomment MIMEMagicFile conf/magic

		pridat do mime.types: application/x-httpd-php php php5

		(test.php - phpinfo: funguje to)

	php.ini:
		date.timezone = Europe/Prague

		extension=exif.so
		extension=ftp.so
		extension=gd.so
		extension=iconv.so
		extension=mcrypt.so
		extension=mysqli.so
		extension=mysql.so
		extension=openssl.so
		extension=pdo_mysql.so
		extension=soap.so
		extension=xmlrpc.so
		extension=xsl.so
		extension=zip.so

		pacman -S php-mcrypt php-sqlite php-gd

	Virtualni host work.

		PassengerPreStart http://orldecin.cz
		PassengerPreStart http://kolej.anek.cz

	my.cnf:
		uncomment skip-networking

	pacman -S vsftpd
	systemctl enable vsftpd
	systemctl start vsftpd

	/etc/vsftpd: anonymous_enable=NO
		local_enable=YES
		write_enable=YES
		local_umask=022

	chown -R prvak:http work
	chmod -R 770 work

	(vytvoreni ios-medical databaze a uzivatele)
		create database ios_medical_db;
		grant all privileges on ios_medical_db.* to ios_medical identified by "M3Dical_271";

	/etc/ssh/sshd_config: zmena LogLevel INFO na LogLevel VERBOSE aby fungoval fail2ban

	fail2ban: vsftpd-iptables - zapnout, konf. mailu
		ssh-iptables - zapnout, konf. mailu

	iptables aby fungovalo fail2ban:
		(pacman -S iptables)

		systemctl enable iptables
		systemctl start iptables

		cp /etc/iptables/empty.rules /etc/iptables/iptables.rules (aby to slo zapnout)
		systemctl start iptables

	systemctl restart fail2ban

	vhost pp

	symlink v ~pp na pp.rny.cz

	(presun srv do /home/srv)
	(ln -s /home/srv /srv)

	(prepnuti fail2ban tak, aby se to koukalo spravne do /var/log/auth.log)

	Je potreba mit hodinovy cron na wget http://rezervace.cardiofitnessdc.cz/?presenter=Cron -O/dev/null -o/dev/null > /dev/null.
		(Je to nejaky historicky duvod. Neslo to nastavit na cardiofitnessdc serveru...)

	pacman -S uptimed
	systemctl enable uptimed; systemctl start uptimed

	postfix virtual: "pok@rny.cz prvak@localhost" aby slo posilat maily primo z dragonu (??)

	barvicky v /etc/bash.bashrc

	pacman -S colordiff mlocate
	systemctl enable fail2ban, start fail2ban

	-- fail2ban si stezuje v logu na spatnou syntaxi iptables --
	-- zmenen defaultni jail aby to fungovalo --

	apache: vhost rny.cz dany jako default, pridan vhost podnikani.rny.cz (url rewrite na http://podnikani.tchk.cz)

	systemctl enable ntpd

	orldecin.cz:
		ServerName orldecin.cz
		ServerAlias www.orldecin.cz orldecin.cz

	systemctl enable cronie
	systemctl start cronie

	cron.hourly: rezervace_tick

	obnovuju obsah /root.
		.bash_profile
		.bashrc

	KROK 1) Kopiruju stary server k sobe na disk.

	Seznam sluzeb na serveru:
		* FTP na ordinaci?

		~pp/pp.rny.cz

	Priority:
		1) mail (SMTP & POP3 & IMAP)
		2) ordinace
		3) osobni web

	PLAN OPERACE:
		1) dam instalovat novy Arch
		2) passwd, ssh-copy-id
		3) pacman -Syu
		--- restart ---

		Jestli to tady nabootuje, budu pokracovat.
		4)
			pacman -S bc bind cronie dovecot elinks fail2ban git grub hddtemp htop iputils mc mutt cfdisk php-apache postfix rsync ruby \
				screen smartmontools strace syslog-ng systemd-sysvcompat uptimed v8 vim vsftpd apache

			useradd prvak
			passwd prvak
			ssh-copy-id

		5)	zahajit restoraci z FTP -- nakopirovat nekam do vhodneho mista a soubor po souboru narovnavat
		6) Postfix, Dovecot, peclive otestovat ze to funguje vcetne SSL

	- vituv stary web ('web vp')

		1) 00:03: spustena reinstalace serveru
		2) 00:21: dorazil mail s heslem
			passwd, ssh-copy-id

		3) 00:26: mam heslo a klic
			pacman -Syu ==> nothing to do

		4) 00:27: reboot

		5) 00:28: install
	,
			pacman -S bc bind cronie dovecot elinks fail2ban git grub hddtemp htop iputils mc mutt cfdisk php-apache postfix rsync ruby \
				screen smartmontools strace syslog-ng systemd-sysvcompat uptimed v8 vim vsftpd apache

			(cfdisk not found -- uz tam je)

			hostname (/etc/hostname): ks389438 ==> wintermute

		6) zahajeni restorace z FTP -- kopiruju

			Mezitim na pozadi (protoze se tech dat kopiruje hodne) zacinam s restoraci postfixu a dovecotu.

			systemctl enable syslog-ng
			systemctl start syslog-ng

		7*) (mezitim co kopiruju)
			useradd -m prvak
			passwd prvak

			ssh-copy-id prvak@rny.cz

		8*) (mezitim co kopiruju, mam uz etc)

			(nakopirovani a nadiffovani konfiguraku)

			diff /home/_FTP_RESTORE/postfix/ /etc/postfix/ > ~/postfix-diff

			aliases: 'root: you' ==> 'root: prvak'
				'pok: prvak' (pok@rny.cz)
			$ postalias aliases
			$ postmap generic

			main.cf:
				myhostname = mail.rny.cz
				mydomain = rny.cz
				myorigin = $mydomain
				inet_interfaces = all
				mydestination = $myhostname, localhost.$mydomain, localhost,
					$mydomain, mail.$mydomain, www.$mydomain, ftp.$mydomain
				home_mailbox = Maildir/

				# A na konec:
				smtpd_sasl_auth_enable = yes
				smtpd_sasl_type = dovecot
				smtpd_sasl_path = private/auth
				broken_sasl_auth_clients = yes
				smtpd_sasl_security_options = noanonymous
				smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated reject_unauth_destination
				smtpd_recipient_restrictions = permit_mynetworks permit_sasl_authenticated reject_unauth_destination

				smtpd_tls_cert_file = /etc/ssl/certs/postfix.crt
				smtpd_tls_key_file = /etc/ssl/private/postfix.pem
				smtpd_tls_security_level = may

				# Warningy, kdyz je mail delsi dobu ve queue.
				delay_warning_time = 15m

				smtp_generic_maps = hash:/etc/postfix/generic

			master.cf:
				pridana radka se SMTP nestandartnim portem
				smtp      inet  n       -       n       -       -       smtpd

			virtual:
				pok@rny.cz prvak@localhost

			postmap virtual

			rm ~/postfix-diff

			systemctl enable postfix

			mkdir -p /etc/ssl/{certs,private} &&
			cp /home/_FTP_RESTORE/etc/ssl/certs/postfix.crt /etc/ssl/certs &&
			cp /home/_FTP_RESTORE/etc/ssl/private/postfix.pem /etc/ssl/private

			diff /home/_FTP_RESTORE/etc/dovecot/ /etc/dovecot/ > ~/dovecot-diff
			cp /home/_FTP_RESTORE/etc/dovecot/dovecot.conf /etc/dovecot

			systemctl start postfix dovecot

			(Test IMAPu)
			v mail.log:: Fatal: Couldn't parse private ssl_key: error:0906D06C:PEM routines:PEM_read_bio:no start line: Expecting: ANY PRIVATE KEY

			cp /home/_FTP_RESTORE/etc/dovecot/conf.d/10-ssl.conf /etc/dovecot/conf.d
			cp /home/_FTP_RESTORE/etc/dovecot/conf.d/10-auth.conf /etc/dovecot/conf.d

			cp /home/_FTP_RESTORE/etc/ssl/certs/dovecot.pem /etc/ssl/certs &&
			cp /home/_FTP_RESTORE/etc/ssl/private/dovecot.pem /etc/ssl/private

			systemctl restart postfix dovecot

			(Test: fetchmail se uspesne pripojil)
			(Test: mail na pok@rny.cz: OK, delivered & fetched)
			(Test: mail na root@rny.cz: OK, delivered & fetched)
			(Test: mail na mp@decin.cz: OK, delivered & fetched)

		9) Poustim dalsi kopirovani stareho /home.

		(01:17) je to nejak jakz takz funkcni.

		DALE BUDE POTREBA:
			- tatuv uzivatel a symlink do ordinace

	===

	pacman -S ack
	zkopirovani srv/http a zmervoani konfigurace

	odebrat: - MIMEMagicFile
	MPM: prefork, ne event

	===> mam uz funkcni ordinaci
""" .
