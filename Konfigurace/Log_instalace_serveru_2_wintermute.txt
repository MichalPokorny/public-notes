KROK 1) Kopiruju stary server k sobe na disk.

	Z passwd, gpasswd by mel zmizet b4f-crm, crm-b4f (jeden z tehle) a pi-tunnel.

	mine-tunnel: urceno k tunelovani z Tezitka

UPRAVY:	vypnuto magic.rny.cz, protoze to uz nema smysl.
	vypnuto priv.rny.cz, tmp.rny.cz, work.rny.cz, pub.rny.cz (pripadne zapnu pozdejs)
	vypnuto podnikani.rny.cz
	odebrano /srv/rails/ordinace, dano do zaloh
	SVN jch, tomi odebrano

Seznam sluzeb na serveru:
	* Tomiho idnesMailer
		-- ono to uklada kopie do 'sent'... to je ale blbost...

	* FTP na ordinaci?

	~pp/pp.rny.cz

	* uzivatel mine-tunnel

Priority:
	1) mail (SMTP & POP3 & IMAP)
	2) ordinace
	3) osobni web
	4) penezotron


Seznam explicitne nainstalovanych baliku, co nejsou nicim requirenute:
	ack 2.12-1
	autoconf 2.69-1
	automake 1.14.1-1
	bc 1.06.95-1
	bind 9.9.5.W1-2
	bison 3.0.2-1
	btrfs-progs 3.12-1
	colordiff 1.0.13-1
	cronie 1.4.11-1
	cryptsetup 1.6.4-1
	dmidecode 2.12-2
	dnsutils 9.9.2.P2-1
	dovecot 2.2.11-1
	elinks 0.13-15
	ethtool 1:3.13-1
	fail2ban 0.9.0-2
	fakeroot 1.20-1
	flex 2.5.39-1
	git 1.9.1-1
	grub 1:2.02.beta2-2
	hddtemp 0.3.beta15.52-2
	htop 1.0.2-2
	iputils 20121221-3
	irqbalance 1.0.7-1
	jfsutils 1.1.15-4
	libtool 2.4.2-12
	licenses 20130203-1
	lvm2 2.02.105-2
	make 4.0-2
	man-pages-de 1.4-1
	man-pages-it 3.60-1
	mariadb 5.5.36-1
	mc 4.8.12-1
	mdadm 3.3-2
	mlocate 0.26-1
	mtr 0.85-1
	mutt 1.5.23-1
	nano 2.2.6-2
	net-tools 1.60.20130531git-1
	netcfg 3.2-1
	nmap 6.40-1
	nodejs 0.10.26-1
	ntp 4.2.6.p5-19
	openssh 6.6p1-1
	parted 3.1-4
	patch 2.7.1-2
	pciutils 3.2.1-1
	php-apache 5.5.11-1
	php-gd 5.5.11-1
	php-mcrypt 5.5.11-1
	php-sqlite 5.5.11-1
	pkg-config 0.28-1
	postfix 2.11.0-2
	procps-ng 3.3.9-2
	psmisc 22.20-1
	reiserfsprogs 3.6.24-1
	rsync 3.1.0-1
	ruby 2.1.1-2
	screen 4.0.3-15
	smartmontools 6.2-1
	strace 4.8-1
	subversion 1.8.8-1
	sudo 1.8.10.p2-1
	syslog-ng 3.5.3-1
	systemd-sysvcompat 212-1
	tcpdump 4.5.1-1
	uptimed 0.3.17-5
	usbutils 007-1
	v8 3.23.17.23-1
	vi 1:050325-3
	vim 7.4.214-1
	vlan 1.9-3
	vsftpd 3.0.2-2
	wget 1.15-1
	which 2.20-6
	xfsprogs 3.1.11-2
	yaourt 1.3-1

Budu instalovat:
	ack
	colordiff
	(netcfg???)
	passenger?

	bc
	bind
	cronie
	dovecot
	elinks
	fail2ban
	git
	grub
	hddtemp
	htop
	iputils
	mc
	mutt
	cfdisk
	php-apache
	postfix
	rsync
	ruby
	screen
	smartmontools
	strace
	syslog-ng
	systemd-sysvcompat
	uptimed
	v8
	vim
	vsftpd

	apache

PLAN OPERACE:
	1) dam instalovat novy Arch
	2) passwd, ssh-copy-id
	3) pacman -Syu
	--- restart ---

	Jestli to tady nabootuje, budu pokracovat.
	4)
		pacman -S bc bind cronie dovecot elinks fail2ban git grub hddtemp htop iputils mc mutt cfdisk php-apache postfix rsync ruby \
			screen smartmontools strace syslog-ng systemd-sysvcompat uptimed v8 vim vsftpd apache

		useradd prvak
		passwd prvak
		ssh-copy-id

	5)	zahajit restoraci z FTP -- nakopirovat nekam do vhodneho mista a soubor po souboru narovnavat
	6) Postfix, Dovecot, peclive otestovat ze to funguje vcetne SSL

Nechci nikdy zalohovat .swp, .swo, ...
	*.o a spustitelny?
	*.hi a je soubor *.hs?
	*.exe?

	*.aux? *.log? (development.log)

- temp / tmp: vycistit
- cache
- vydiffovat stare backupy
- vituv stary web ('web vp')

	1) 00:03: spustena reinstalace serveru
	2) 00:21: dorazil mail s heslem
		passwd, ssh-copy-id

	3) 00:26: mam heslo a klic
		pacman -Syu ==> nothing to do

	4) 00:27: reboot

	5) 00:28: install
,
		pacman -S bc bind cronie dovecot elinks fail2ban git grub hddtemp htop iputils mc mutt cfdisk php-apache postfix rsync ruby \
			screen smartmontools strace syslog-ng systemd-sysvcompat uptimed v8 vim vsftpd apache

		(cfdisk not found -- uz tam je)

		hostname (/etc/hostname): ks389438 ==> wintermute

	6) zahajeni restorace z FTP -- kopiruju

		Mezitim na pozadi (protoze se tech dat kopiruje hodne) zacinam s restoraci postfixu a dovecotu.

		systemctl enable syslog-ng
		systemctl start syslog-ng

	7*) (mezitim co kopiruju)
		useradd -m prvak
		passwd prvak

		ssh-copy-id prvak@rny.cz

	8*) (mezitim co kopiruju, mam uz etc)

		(nakopirovani a nadiffovani konfiguraku)

		diff /home/_FTP_RESTORE/postfix/ /etc/postfix/ > ~/postfix-diff

		aliases: 'root: you' ==> 'root: prvak'
			'pok: prvak' (pok@rny.cz)
		$ postalias aliases
		$ postmap generic

		main.cf:
			myhostname = mail.rny.cz
			mydomain = rny.cz
			myorigin = $mydomain
			inet_interfaces = all
			mydestination = $myhostname, localhost.$mydomain, localhost,
				$mydomain, mail.$mydomain, www.$mydomain, ftp.$mydomain
			home_mailbox = Maildir/

			# A na konec:
			smtpd_sasl_auth_enable = yes
			smtpd_sasl_type = dovecot
			smtpd_sasl_path = private/auth
			broken_sasl_auth_clients = yes
			smtpd_sasl_security_options = noanonymous
			smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated reject_unauth_destination
			smtpd_recipient_restrictions = permit_mynetworks permit_sasl_authenticated reject_unauth_destination

			smtpd_tls_cert_file = /etc/ssl/certs/postfix.crt
			smtpd_tls_key_file = /etc/ssl/private/postfix.pem
			smtpd_tls_security_level = may

			# Warningy, kdyz je mail delsi dobu ve queue.
			delay_warning_time = 15m

			smtp_generic_maps = hash:/etc/postfix/generic

		master.cf:
			pridana radka se SMTP nestandartnim portem
			smtp      inet  n       -       n       -       -       smtpd

		virtual:
			pok@rny.cz prvak@localhost

		postmap virtual

		rm ~/postfix-diff

		systemctl enable postfix

		mkdir -p /etc/ssl/{certs,private} &&
		cp /home/_FTP_RESTORE/etc/ssl/certs/postfix.crt /etc/ssl/certs &&
		cp /home/_FTP_RESTORE/etc/ssl/private/postfix.pem /etc/ssl/private

		diff /home/_FTP_RESTORE/etc/dovecot/ /etc/dovecot/ > ~/dovecot-diff
		cp /home/_FTP_RESTORE/etc/dovecot/dovecot.conf /etc/dovecot

		systemctl start postfix dovecot

		(Test IMAPu)
		v mail.log:: Fatal: Couldn't parse private ssl_key: error:0906D06C:PEM routines:PEM_read_bio:no start line: Expecting: ANY PRIVATE KEY

		cp /home/_FTP_RESTORE/etc/dovecot/conf.d/10-ssl.conf /etc/dovecot/conf.d
		cp /home/_FTP_RESTORE/etc/dovecot/conf.d/10-auth.conf /etc/dovecot/conf.d

		cp /home/_FTP_RESTORE/etc/ssl/certs/dovecot.pem /etc/ssl/certs &&
		cp /home/_FTP_RESTORE/etc/ssl/private/dovecot.pem /etc/ssl/private

		systemctl restart postfix dovecot

		(Test: fetchmail se uspesne pripojil)
		(Test: mail na pok@rny.cz: OK, delivered & fetched)
		(Test: mail na root@rny.cz: OK, delivered & fetched)
		(Test: mail na mp@decin.cz: OK, delivered & fetched)

	9) Poustim dalsi kopirovani stareho /home.

	(01:17) je to nejak jakz takz funkcni.

	DALE BUDE POTREBA:
		- tatuv uzivatel a symlink do ordinace

===

pacman -S ack
zkopirovani srv/http a zmervoani konfigurace

odebrat: - MIMEMagicFile
MPM: prefork, ne event

===> mam uz funkcni ordinaci

passenger
(nainstalovani a tak)

pacman -S make

symlink na bundle v penezotronu, vsechno patri railsum, Directory v apache konfiguraci
ln -s /srv/rails/penezotron/shared/database.yml database.yml

pacman -S mariadb
(nakopirovani SQL databaze)

systemctl restart mysqld
systemctl enable mysqld httpd

Funguje mi penezotron.

obnovuju obsah /root.
	.bash_profile
	.bashrc

systemctl enable cronie
systemctl start cronie

pacman -S colordiff mlocate

cron.hourly: rezervace_tick

mysqld: skip-networking

systemctl enable fail2ban, start fail2ban

-- fail2ban si stezuje v logu na spatnou syntaxi iptables --
-- zmenen defaultni jail aby to fungovalo --

(4.5.2014)
	5) FTP na ordinaci, user 'pp'
